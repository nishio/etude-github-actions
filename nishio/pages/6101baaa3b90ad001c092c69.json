{
  "id": "6101baaa3b90ad001c092c69",
  "title": "ScrapboxでCtrl+EnterしてKeichoに質問させる",
  "created": 1627503276,
  "updated": 1627506780,
  "lines": [
    {
      "id": "6101baaa3b90ad001c092c69",
      "text": "ScrapboxでCtrl+EnterしてKeichoに質問させる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627503276,
      "updated": 1627503276
    },
    {
      "id": "6101c6c6aff09e00007f67c4",
      "text": "[https://gyazo.com/1858e84d0c918645c4c089ec8e92f3ee]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506374,
      "updated": 1627506375
    },
    {
      "id": "6101c7cdaff09e0000af1bd0",
      "text": "ScrapboxでCtrl+EnterしてKeichoに質問させる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506637,
      "updated": 1627506679
    },
    {
      "id": "6101c7f7aff09e00004693b0",
      "text": "https://keicho.netlify.app/#talk=lSI8KHGqEfzXAACvih5f",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506679,
      "updated": 1627506679
    },
    {
      "id": "6101c7f7aff09e00004693b1",
      "text": "[/nishio/nisbot.icon]その「Scrapbox」は、どんな「Scrapbox」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506679,
      "updated": 1627506679
    },
    {
      "id": "6101c7f7aff09e00004693b2",
      "text": "チャットではなくWiki",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506679,
      "updated": 1627506704
    },
    {
      "id": "6101c810aff09e00004693b3",
      "text": "[/nishio/nisbot.icon]その「Wiki」は、どんな「Wiki」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506704,
      "updated": 1627506704
    },
    {
      "id": "6101c810aff09e00004693b4",
      "text": "...(keicho)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506704,
      "updated": 1627506716
    },
    {
      "id": "6101c7ddaff09e0000af1bd1",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506653,
      "updated": 1627506653
    },
    {
      "id": "6101c825aff09e00004693b5",
      "text": "derived from [/takker/選択範囲をKeichoに尋ねるPopupMenu]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506726,
      "updated": 1627506780
    },
    {
      "id": "6101c85baff09e00004693b7",
      "text": "\t[選択範囲をKeichoに尋ねるPopupMenu]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506780,
      "updated": 1627506780
    },
    {
      "id": "6101c825aff09e00004693b6",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506726,
      "updated": 1627506726
    },
    {
      "id": "6101c6c6aff09e00007f67c6",
      "text": "code:script.js",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506375,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67c9",
      "text": " import { insertText } from \"/api/code/takker/scrapbox-insert-text-2/script.js\";",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67ca",
      "text": " document.body.onkeypress = (e) => {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67cb",
      "text": "   if (e.key === \"Enter\" && e.ctrlKey) {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67cc",
      "text": "     ask_keicho();",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67cd",
      "text": "   }",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67ce",
      "text": " };",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67cf",
      "text": " ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d0",
      "text": " const REGEXP_URL = /https:\\/\\/keicho\\.netlify\\.app\\/#talk=(\\w+)/;",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d1",
      "text": " const getTalkId = () => {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d2",
      "text": "   let talkId = null;",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d3",
      "text": "   scrapbox.Page.lines.forEach((line) => {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d4",
      "text": "     const matches = line.text.match(REGEXP_URL);",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d5",
      "text": "     if (matches !== null) {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d6",
      "text": "       matches.forEach((m) => {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d7",
      "text": "         talkId = m;",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d8",
      "text": "       });",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67d9",
      "text": "     }",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67da",
      "text": "   });",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67db",
      "text": "   return talkId;",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67dc",
      "text": " };",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67dd",
      "text": " ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67de",
      "text": " const ask_keicho = async (text = null) => {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67df",
      "text": "   // idを取得する",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e0",
      "text": "   const id = await getTalkId();",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e1",
      "text": "   if (text === null) {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e2",
      "text": "     const XPATH = \"//span[@class='text' and contains(.,'(keicho)')]\";",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e3",
      "text": "     const current_line = document.evaluate(XPATH, document).iterateNext();",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e4",
      "text": "     text = current_line.innerText.replace(\"(keicho)\", \"\");",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e5",
      "text": "   }",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e6",
      "text": "   console.log(text);",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e7",
      "text": "   let { id: _id, text: answer } = await askKeicho(text, { id });",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e8",
      "text": "   // idが更新されたらURLを作る",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67e9",
      "text": "   const code = id !== _id ? `https://keicho.netlify.app/#talk=${_id}\\n` : \"\";",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67ea",
      "text": "   answer = answer.replace(/\\n+/g, \"\\n\").replaceAll(\">\\n\", \"\\n\");",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67eb",
      "text": "   const ICON = \"[/nishio/nisbot.icon]\";",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67ec",
      "text": "   await insertText(`\\n${code}${ICON}${answer}\\n`);",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67ed",
      "text": " };",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67ee",
      "text": " ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67ef",
      "text": " scrapbox.PopupMenu.addButton({",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f0",
      "text": "   title: \"🤖\",",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f1",
      "text": "   onClick: (text) => {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f2",
      "text": "     ask_keicho(text);",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f3",
      "text": " ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f4",
      "text": "     // botの記入欄を作っておく",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f5",
      "text": "     return `${text}\\n`;",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f6",
      "text": "   },",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f7",
      "text": " });",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c762aff09e00007f67f8",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506530,
      "updated": 1627506530
    },
    {
      "id": "6101c6ceaff09e00007f67c7",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506383,
      "updated": 1627506383
    },
    {
      "id": "6101c6ceaff09e00007f67c8",
      "text": "---",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506383,
      "updated": 1627506384
    },
    {
      "id": "6101c6c6aff09e00007f67c5",
      "text": "ver.1",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627506374,
      "updated": 1627506382
    },
    {
      "id": "6101baabaff09e0000bfe8ce",
      "text": "[https://gyazo.com/dd0fb433a12ee640218814c6b2307b2c]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627503276,
      "updated": 1627503908
    },
    {
      "id": "6101baacaff09e0000bfe8d0",
      "text": "コンソールに入力文が流れてるタイミングでCtrl+Enterしてる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627503276,
      "updated": 1627503989
    },
    {
      "id": "6101bd75aff09e000064cce9",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627503989,
      "updated": 1627503989
    },
    {
      "id": "6101bd75aff09e000064ccea",
      "text": "最後に画面にない引用文が出てるのは、今のシステムがScrapboxのページを見て引用するのではなく、過去に入力されたものから引用するから、ここまでにテスト入力したものがScrapboxの方で消してもKeichoは覚えてることが原因",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627503990,
      "updated": 1627504072
    },
    {
      "id": "6101bd74aff09e000064cce8",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1627503989,
      "updated": 1627503989
    }
  ]
}