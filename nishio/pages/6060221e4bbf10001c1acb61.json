{
  "id": "6060221e4bbf10001c1acb61",
  "title": "謎のログが途切れるバグが起きたので相談したい",
  "created": 1616912927,
  "updated": 1616913158,
  "lines": [
    {
      "id": "6060221e4bbf10001c1acb61",
      "text": "謎のログが途切れるバグが起きたので相談したい",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912927,
      "updated": 1616912927
    },
    {
      "id": "6060221eaff09e0000a0e791",
      "text": "まとめ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912927,
      "updated": 1616912958
    },
    {
      "id": "6060223eaff09e0000b9643e",
      "text": "　よくわからないバグが発生したので悩んで相談した",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912958,
      "updated": 1616913040
    },
    {
      "id": "60602259aff09e0000b9643f",
      "text": "　当初認識していた「ログが途切れる」が、現象の認識として正しくないことがわかった",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912986,
      "updated": 1616913136
    },
    {
      "id": "606022efaff09e00009d96e6",
      "text": "　　正しくは「ログが二つの会話に分かれる」",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616913136,
      "updated": 1616913139
    },
    {
      "id": "606022dbaff09e00009d96e5",
      "text": "　ログが消えてないことがわかって一安心",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616913115,
      "updated": 1616913140
    },
    {
      "id": "606022adaff09e0000b96441",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616913069,
      "updated": 1616913069
    },
    {
      "id": "6060221eaff09e0000a0e792",
      "text": "[nisbot.icon]あなたはこの会話で何が起きて欲しいですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912927,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96408",
      "text": "[nishio.icon]謎のログが途切れるバグが起きたので相談したい",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96409",
      "text": "[nisbot.icon]その「バグ」は、どんな「バグ」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9640a",
      "text": "[nishio.icon]ログのうち冒頭の数行が失われるという現象が起きた。サーバに保存されているデータでも冒頭が失われている。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9640b",
      "text": "[nisbot.icon]その「ログ」は、どんな「ログ」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9640c",
      "text": "[nishio.icon]会話のログ。チャットにユーザが入力したものとボットが返事したものがリストになっている。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9640d",
      "text": "[nisbot.icon]その「ログ」について、他に何かありますか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9640e",
      "text": "[nishio.icon]そもそもサーバには1行の発言を送って、サーバサイドで追記をしているはずなのに、なんで途中で途切れるのか不可解",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9640f",
      "text": "[nisbot.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96410",
      "text": " > 会話のログ。チャットにユーザが入力したものとボットが返事したものがリストになっている。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96411",
      "text": " この「ログ」は、どのあたりにありますか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96412",
      "text": "[nishio.icon]サーバにある",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96413",
      "text": "[nisbot.icon]その「サーバ」は、どんな「サーバ」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96414",
      "text": "[nishio.icon]Herokuで文字列を受け取って返答のレスポンスを返す。状態はFirestoreに保存される。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96415",
      "text": "[nisbot.icon]その「保存する」は、どんな「保存する」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96416",
      "text": "[nishio.icon]トークIDをキーとするKVSになっていて、そこに会話継続に必要な内部状態をJSONに変換して入れている。JSONなのは歴史的経緯、実際に使うときにはdefaultdictとかなのだけどこれはそのままFirestoreに入らないので保存する前にFirestoreに入る形に変換する必要があり、その変換方法でたまたまJSONを選んだだけ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96417",
      "text": "[nisbot.icon]あなたが価値を感じているのは何ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96418",
      "text": "[nishio.icon]バグが解消してほしい。ログが失われるのは損失だし、失われるかもしれないと思ってると安心して使えない。ざっと怪しい操作をしてみたけど再現しなくて頭を抱えている",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96419",
      "text": "[nisbot.icon]その「ログ」は、どこにありますか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9641a",
      "text": "[nishio.icon]Firestoreにある。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9641b",
      "text": "[nisbot.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9641c",
      "text": " > バグが解消してほしい。ログが失われるのは損失だし、失われるかもしれないと思ってると安心して使えない。ざっと怪しい操作をしてみたけど再現しなくて頭を抱えている",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9641d",
      "text": " この「ログ」は、何のようですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9641e",
      "text": "[nishio.icon]追記するファイル。ログが消えたとなると上書きしたのかなと思うわけだが、そもそもロードして追加して書き戻してるはずなので消えるのが不可解",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9641f",
      "text": "[nisbot.icon]その「ログ」は、どこから来るのですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96420",
      "text": "[nishio.icon]えーとね、今回怪しいと思ってる機能は最近つけた「過去の会話を開いて続行する機能」で、実際にログが消えた時もそれを使いまくってた。この機能を使った時は、まずブラウザのIndexedDBに入ってる会話IDでFirestoreにアクセスして過去のログを取得してそれを表示する。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96421",
      "text": "[nisbot.icon]あなたはその「ログ」をどう知るのですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96422",
      "text": "[nishio.icon]Firestoreに会話IDを送って「この会話のログをくれ」ってやる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96423",
      "text": "[nisbot.icon]その「ログ」に関して、何が起こるとよいですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96424",
      "text": "[nishio.icon]消えないか、せめて消える現象の再現方法がわかってほしい。再現しないとデバッグできない。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96425",
      "text": "[nisbot.icon]それには「ログ」に何が起こる必要がありますか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96426",
      "text": "[nishio.icon]わからない！",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96427",
      "text": "[nisbot.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96428",
      "text": " > Firestoreに会話IDを送って「この会話のログをくれ」ってやる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96429",
      "text": " この「Firestore」は、どんな「Firestore」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9642a",
      "text": "[nishio.icon]単なるサーバ上のKVS",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9642b",
      "text": "[nisbot.icon]その「サーバ」について、他に何かありますか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9642c",
      "text": "[nishio.icon]サーバ上の値を調査しやすくするためにローカルにダウンロードするスクリプトが用意してあって、それを使ってたしかに問題のログの冒頭が途切れてるのを見たのだが、その時に他にも数件ダウンロードされたな。それらがどんなデータなのかも見てみるべきか",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9642d",
      "text": "[nisbot.icon]あなたはその「サーバ」をどう知るのですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9642e",
      "text": "[nishio.icon]サーバがどんな状態になってるか知る一番いい方法がそれだからね",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9642f",
      "text": "[nisbot.icon]その「サーバ」は、どこにありますか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96430",
      "text": "[nishio.icon]ローカルにあるコピーを観察してくる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96431",
      "text": "[nisbot.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96432",
      "text": " > サーバがどんな状態になってるか知る一番いい方法がそれだからね",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96433",
      "text": " この「サーバ」に関して、何が起こるとよいですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96434",
      "text": "[nishio.icon]わかった、ログは消えたのではなく二つの会話に分かれてる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96435",
      "text": "[nisbot.icon]その「会話」は、どんな「会話」ですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96436",
      "text": "[nishio.icon]つまり、僕は一つの会話をしているつもりでいたが、何らかの操作ミスかなにかで一つ目の会話の最中に別の新しい会話を開始してしまっていたようだ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96437",
      "text": "[nisbot.icon]その「会話」について、他に何かありますか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96438",
      "text": "[nishio.icon]いまブラウザに保存されてた過去の会話一覧を見てきたのだが、たしかに2つの会話があった。それに気づかずに2つ目の会話が終わったタイミングでログ表示をしたから、後半の会話のログしか表示されず「前半が失われた？！」と勘違いしたわけか。前半のログも問題なく見れた。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b96439",
      "text": "[nisbot.icon]あなたはその「会話」をどう知るのですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9643a",
      "text": "[nishio.icon]過去の会話一覧機能をつけておいて良かったね。そこを見ればわかる。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9643b",
      "text": "[nisbot.icon]その「会話」は、何のようですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9643c",
      "text": "[nishio.icon]消えても構わない口頭の会話と違って、ログが残って後から読み返せることを大事だと思ってる。書き物のイメージなんだな。だから「ログが消えた？！」と焦ったけど、とりあえず消えてはないことがわかって一安心。",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    },
    {
      "id": "60602224aff09e0000b9643d",
      "text": "[nisbot.icon]その「会話」は、どこから来るのですか？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1616912933,
      "updated": 1616912933
    }
  ]
}